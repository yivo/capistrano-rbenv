namespace :rbenv do
  task :map_bins do
    rbenv_root = expand_home_dir(fetch(:rbenv_root), user: fetch(:user))

    rbenv_prefix = fetch(:rbenv_prefix, -> { "#{rbenv_root}/bin/rbenv exec" })
    SSHKit.config.command_map[:rbenv] = "#{rbenv_root}/bin/rbenv"
    fetch(:rbenv_map_bins).each do |command|
      SSHKit.config.command_map.prefix[command.to_sym].unshift(rbenv_prefix)
    end
  end
end

Capistrano::DSL.stages.each do |stage|
  after stage, 'rbenv:map_bins'
end